# my-k8s-configs/kai-test-kafka/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kai-test-kafka-config
  namespace: kai-test-kafka # Disarankan untuk mendefinisikan namespace secara eksplisit
data:
  # Nama kunci harus 'application.yml' agar dibaca oleh Spring Boot
  application.yml: |
    # Topic kustom Anda
    kafka:
      topic:
        presensi-log: presensi-log

    # Konfigurasi utama Spring Boot
    spring:
      application:
        name: kai-test-kafka
      profiles:
        active: development
      # Konfigurasi Kafka
      kafka:
        bootstrap-servers: 43.157.209.107:30992
        consumer:
          group-id: presensi-log-batch-consumer-group-v3
          auto-offset-reset: earliest
          enable-auto-commit: false
          key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
          value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
          # Properti fetch
          fetch-max-wait-ms: 5000
          fetch-min-bytes: 1
          max-poll-records: 500
        listener:
          type: batch
          ack-mode: MANUAL_IMMEDIATE
      
      # Konfigurasi Database (JPA & Datasource)
      datasource:
        # Konfigurasi untuk datasource master
        rolink-master:
          url: jdbc:postgresql://43.157.209.107:31001/mydb?currentSchema=starlink
          username: pguser
          password: pgpass
          driver-class-name: org.postgresql.Driver
          test-while-idle: true
          test-on-borrow: true
          validation-query: SELECT 1
          hikari:
            minimum-idle: 5
            maximum-pool-size: 20
            idle-timeout: 30000
            max-lifetime: 1800000
            connection-timeout: 30000
        # Konfigurasi untuk datasource slave
        rolink-slave:
          url: jdbc:postgresql://43.157.209.107:31001/mydb?currentSchema=starlink
          username: pguser
          password: pgpass
          driver-class-name: org.postgresql.Driver
          test-while-idle: true
          test-on-borrow: true
          validation-query: SELECT 1
          hikari:
            minimum-idle: 5
            maximum-pool-size: 20
            idle-timeout: 30000
            max-lifetime: 1800000
            connection-timeout: 30000

      jpa:
        database-platform: org.hibernate.dialect.PostgreSQLDialect
        hibernate:
          # ddl-auto: validate # Sebaiknya tidak diaktifkan di production
          naming:
            physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        properties:
          hibernate:
            jdbc:
              batch_size: 50
            order_inserts: true
            order_updates: true
            batch_versioned_data: true
        # show-sql: true

    # Konfigurasi Server
    server:
      port: 8082

